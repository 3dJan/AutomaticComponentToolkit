/*++

Copyright (C) 2021 ADSK

All rights reserved.

This file has been generated by the Automatic Component Toolkit (ACT) version 1.7.0-develop.

Abstract: This is an autogenerated C application that demonstrates the
 usage of the C bindings of RTTI

Interface version: 1.0.0

*/

#include <stdio.h>
#include <stdlib.h>
#include "rtti_dynamic.h"

#define printf_s printf

void releaseWrapper(sRTTIDynamicWrapperTable* pWrapperTable) {
	RTTIResult eResult = ReleaseRTTIWrapperTable(pWrapperTable);
	if (RTTI_SUCCESS != eResult) {
		printf_s("Failed to release wrapper table\n");
	}
}

int main()
{
	// TODO: put a path to RTTI binary file here:
	const char* libpath = "./rtti.dylib";
	sRTTIDynamicWrapperTable sWrapperTable;
	RTTIResult eResult = RTTI_SUCCESS;
	 
	eResult = InitRTTIWrapperTable(&sWrapperTable);
	if (RTTI_SUCCESS != eResult) {
		printf_s("Failed to initialize wrapper table\n");
		return eResult;
	}
	
	eResult = LoadRTTIWrapperTable(&sWrapperTable, libpath);
	if (RTTI_SUCCESS != eResult) {
		printf_s("Failed to load rtti-binary\n");
		return eResult;
	}
	RTTI_uint32 nMajor, nMinor, nMicro;
	eResult = sWrapperTable.m_GetVersion(&nMajor, &nMinor, &nMicro);
	if (RTTI_SUCCESS != eResult) {
		printf_s("Failed to get version\n");
		releaseWrapper(&sWrapperTable);
		return eResult;
	}
	printf_s("RTTI.Version = %d.%d.%d", nMajor, nMinor, nMicro);
	
	printf_s("\n");
	
	RTTI_Zoo Zoo;
	eResult = sWrapperTable.m_CreateZoo(&Zoo);
	if (RTTI_SUCCESS != eResult) {
		printf_s("Failed to get Zoo\n");
		releaseWrapper(&sWrapperTable);
		return eResult;
	}

	RTTI_AnimalIterator Iterator;
	eResult = sWrapperTable.m_Zoo_Iterator(Zoo, &Iterator);
	if (RTTI_SUCCESS != eResult) {
		printf_s("Failed to get Iterator\n");
		releaseWrapper(&sWrapperTable);
		return eResult;
	}

	while (1) {
		RTTI_Animal Animal;
		eResult = sWrapperTable.m_AnimalIterator_GetNextAnimal(Iterator, &Animal);
		if (RTTI_SUCCESS != eResult) {
			printf_s("Failed to get Iterator\n");
			releaseWrapper(&sWrapperTable);
			return eResult;
		}

		if (!Animal.Handle)
			break;

		RTTI_uint32 CharsRead = 0;
		char Name[255];
		if (RTTI_SUCCESS != sWrapperTable.m_Animal_Name(Animal, 0, &CharsRead, 0)
		|| RTTI_SUCCESS != sWrapperTable.m_Animal_Name(Animal, CharsRead, &CharsRead, &Name[0])) {
			printf_s("Failed to call Animal name\n");
			releaseWrapper(&sWrapperTable);
			return eResult;
		}
		printf_s("Animal name: %s\n", Name);
	}

	eResult = ReleaseRTTIWrapperTable(&sWrapperTable);
	if (RTTI_SUCCESS != eResult) {
		printf_s("Failed to release wrapper table\n");
		return eResult;
	}
	
	return 0;
}

